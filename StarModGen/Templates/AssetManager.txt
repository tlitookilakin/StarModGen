using StardewModdingAPI;
using StardewModdingAPI.Events;
using StardewValley;

{% if Entry.Space -%}
namespace {{Entry.Space}};
{% endif -%}

{% if Entry.isStatic -%} static {% endif -%} partial class {{Entry.Type}}
{
	{%- for asset in Assets %}
	private IAssetName _nameof_{{asset.VarName}} = null!;
	{%- endfor %}
	{%- for prop in LocalProps %}
	private {%- if Entry.isStatic %} static {% endif %} {{prop.PropType}}? _{{ prop.Prop }} = null;
	{{prop.access}} {%- if Entry.isStatic %} static {% endif %} partial {{prop.PropType}} {{prop.Prop}}
		=> _{{prop.Prop}} ??= Game1.content.Load<{{prop.PropType}}>({{prop.RawAsset}});
	{% endfor %}

	{{Entry.access}} {% if Entry.isStatic -%} static {% endif -%} partial void {{Entry.Method}}(IModHelper helper)
	{
		StarModGen.Utils.AssetHelper.Init(helper);
		helper.Events.Content.AssetsInvalidated += _AssetsInvalidatedImpl;
		helper.Events.Content.AssetRequested += _AssetRequestedImpl;
		{% for asset in Assets %}
		_nameof_{{asset.VarName}} = helper.GameContent.ParseAssetName({{asset.Target}});
		{%- endfor %}
	}

	private {% if Entry.isStatic -%} static {% endif -%} void _AssetsInvalidatedImpl(object? sender, AssetsInvalidatedEventArgs e)
	{
		foreach (var name in e.NamesWithoutLocale) 
		{
			{%- for asset in Assets -%}
			{%- if asset.Prop %}
			{% unless forloop.first -%}else {% endunless -%}
			if (name.Equals(_nameof_{{asset.VarName}})) 
			{
				_{{asset.Prop.Prop}} = null;
				{%- if Entry.IsNotify %}{% unless Entry.IsStatic %}
				PropertyChanged?.Invoke(this, new(nameof({{asset.Prop.Prop}})));
				{%- endunless %}{%- endif %}
			}
			{%- endif %}
			{%- endfor %}
		}
	}
	
	private {% if Entry.isStatic -%} static {% endif -%} void _AssetRequestedImpl(object? sender, AssetRequestedEventArgs e)
	{
		var name = e.NameWithoutLocale;

		{% for asset in Assets %}
		{%- if asset.HasAnyHandlers -%}
		{%- unless forloop.first -%}else {% endunless -%}
		if (name.Equals(_nameof_{{asset.VarName}}))
		{
			{% if asset.Prop.Local -%}
			e.LoadFromModFile<{{asset.Prop.PropType}}>("{{asset.Prop.Local}}", AssetLoadPriority.Medium);
			{%- elsif asset.Load -%}
			e.LoadFrom({{asset.Load.Method}}, AssetLoadPriority.Medium);
			{%- endif -%}
			{%- for edit in asset.Edits -%}
			e.Edit({{edit.Method}});
			{%- endfor %}
		}
		{% endif -%}
		{% endfor %}
	}
}